# #!/bin/sh
# module=aesdchar
# device=aesdchar
# mode="664"
# cd `dirname $0`
# set -e
# # Group: since distributions do it differently, look for wheel or use staff
# if grep -q '^staff:' /etc/group; then
#     group="staff"
# else
#     group="wheel"
# fi
# # cd /lib/modules/5.15.18/extra/
# # insmod ./lib/modules/5.15.18/extra/aesdchar.ko
# if [ -e ${module}.ko ]; then
#     echo "Loading local built file ${module}.ko"
#     insmod ./$module.ko $* || exit 1
# else
#     echo "Local file ${module}.ko not found, attempting to modprobe"
#     modprobe ${module} || exit 1
# fi
# echo "makenode"
# # sudo sh -c 'major=$(awk "\$2==\"aesdchar\" {print \$1}" /proc/devices) && \
# # rm -f /dev/aesdchar && \
# # mknod /dev/aesdchar c $major 0 && \
# # chgrp $group /dev/aesdchar && \
# # chmod $mode /dev/aesdchar'

# major=$(awk "\$2==\"aesdchar\" {print \$1}" /proc/devices)
# rm -f /dev/aesdchar
# echo "mknod /dev/aesdchar c ${major} 0"
# mknod /dev/aesdchar c $major 0
# ls /dev/aesdchar
# chgrp $group /dev/aesdchar
# chmod $mode /dev/aesdchar

# # Check if the mknod command succeeded
# if [ $? -eq 0 ]; then
#     echo "Device node /dev/aesdchar created successfully."
# else
#     echo "Failed to create device node /dev/aesdchar."
# fi

# # major=$(awk "\$2==\"aesdchar\" {print \$1}" /proc/devices) && \
# # rm -f /dev/aesdchar && \
# # mknod /dev/aesdchar c $major 0 && \
# # chgrp $group /dev/aesdchar && \
# # chmod $mode /dev/aesdchar

# # major=$(awk "\$2==\"$module\" {print \$1}" /proc/devices)
# # rm -f /dev/${device}
# # mknod /dev/${device} c $major 0
# # chgrp $group /dev/${device}
# # chmod $mode  /dev/${device}


#!/bin/sh

module=aesdchar
device=aesdchar
mode="664"
cd "$(dirname "$0")"
set -e

# Group: since distributions do it differently, look for wheel or use staff
if grep -q '^staff:' /etc/group; then
    group="staff"
else
    group="wheel"
fi

# Load the kernel module
if [ -e "${module}.ko" ]; then
    echo "Loading local built file ${module}.ko"
    insmod "./$module.ko" $* || { echo "Failed to load kernel module ${module}.ko"; exit 1; }
else
    echo "Local file ${module}.ko not found, attempting to modprobe"
    modprobe ${module} || { echo "Failed to modprobe kernel module ${module}"; exit 1; }
fi

# Create device node
major=$(awk "\$2==\"aesdchar\" {print \$1}" /proc/devices)
rm -f /dev/aesdchar
echo "Creating device node /dev/aesdchar"
mknod /dev/aesdchar c "$major" 0 || { echo "Failed to create device node /dev/aesdchar"; exit 1; }
ls /dev/aesdchar
chgrp $group /dev/aesdchar || { echo "Failed to change group ownership of /dev/aesdchar"; exit 1; }
chmod $mode /dev/aesdchar || { echo "Failed to change permissions of /dev/aesdchar"; exit 1; }

echo "Device node /dev/aesdchar created successfully."
